import { createClient } from '@supabase/supabase-js'
import { Database } from './supabase/database.types'

// ============================================
// 环境变量检查
// ============================================
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}

// ============================================
// 主Supabase客户端（客户端使用）
// ============================================
export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: typeof window !== 'undefined' ? window.localStorage : undefined,
    flowType: 'pkce',
  },
  global: {
    headers: {
      'x-application-name': 'ask-gene-web3',
      'x-client-info': 'nextjs',
    },
  },
  db: {
    schema: 'public',
  },
})

// ============================================
// 类型导出（从database.types.ts）
// ============================================
export type Tables = Database['public']['Tables']
export type Enums = Database['public']['Enums']

// 常用表类型
export type Profile = Tables['profiles']['Row']
export type Consultant = Tables['consultants']['Row']
export type Consultation = Tables['consultations']['Row']
export type Feedback = Tables['feedback']['Row']

// ============================================
// 常用查询函数（客户端和服务端都可以用）
// ============================================

// 获取所有已验证的专家
export async function getVerifiedConsultants(options?: {
  limit?: number
  offset?: number
  expertise?: string[]
}) {
  const { limit = 20, offset = 0, expertise } = options || {}

  let query = supabase
    .from('consultants')
    .select('*')
    .eq('is_verified', true)
    .eq('is_active', true)
    .order('rating', { ascending: false })
    .range(offset, offset + limit - 1)

  if (expertise && expertise.length > 0) {
    query = query.contains('expertise', expertise)
  }

  const { data, error } = await query

  if (error) {
    console.error('Error fetching verified consultants:', error)
    return []
  }

  return data || []
}

// 获取单个专家详情
export async function getConsultantById(id: string) {
  const { data, error } = await supabase
    .from('consultants')
    .select('*')
    .eq('id', id)
    .single()

  if (error) {
    console.error('Error fetching consultant:', error)
    return null
  }

  return data
}

// 搜索专家
export async function searchConsultants(query: string, options?: {
  limit?: number
  offset?: number
}) {
  const { limit = 20, offset = 0 } = options || {}

  const { data, error } = await supabase
    .from('consultants')
    .select('*')
    .or(`name.ilike.%${query}%,title.ilike.%${query}%,bio.ilike.%${query}%`)
    .eq('is_verified', true)
    .eq('is_active', true)
    .order('rating', { ascending: false })
    .range(offset, offset + limit - 1)

  if (error) {
    console.error('Error searching consultants:', error)
    return []
  }

  return data || []
}

// 获取专家的反馈
export async function getConsultantFeedback(consultantId: string, options?: {
  limit?: number
  offset?: number
}) {
  const { limit = 20, offset = 0 } = options || {}

  const { data, error } = await supabase
    .from('feedback')
    .select(`
      *,
      consultation:consultations(title, scheduled_for)
    `)
    .eq('consultant_id', consultantId)
    .eq('is_public', true)
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1)

  if (error) {
    console.error('Error fetching consultant feedback:', error)
    return []
  }

  return data || []
}

// 创建咨询预订
export async function createConsultation(consultationData: {
  consultant_id: string
  client_wallet_address: string
  title: string
  description?: string
  scheduled_for: string
  duration_hours: number
}) {
  // 获取专家费率
  const { data: consultant, error: consultantError } = await supabase
    .from('consultants')
    .select('hourly_rate')
    .eq('id', consultationData.consultant_id)
    .single()

  if (consultantError || !consultant) {
    throw new Error('Consultant not found')
  }

  const totalAmount = consultant.hourly_rate * consultationData.duration_hours

  const { data, error } = await supabase
    .from('consultations')
    .insert([{
      ...consultationData,
      hourly_rate: consultant.hourly_rate,
      total_amount: totalAmount,
      status: 'pending',
      payment_status: 'unpaid',
      currency: 'USD',
    }])
    .select()
    .single()

  if (error) {
    console.error('Error creating consultation:', error)
    throw error
  }

  return data
}

// 工具函数
export function formatPrice(amount: number, currency: string = 'USD'): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(amount)
}

export function truncateAddress(address: string, start: number = 6, end: number = 4): string {
  if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
    return address
  }
  return `${address.slice(0, start)}...${address.slice(-end)}`
}
